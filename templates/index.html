<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Treason</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&family=Lato:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --wood-dark: #1a0f05;
            --wood-light: #3e2b19;
            --gold: #d4af37;
            --red: #8a1c1c;
            --green-felt: #2d5a27;
            --parchment: #f4e4bc;
        }

        body {
            background-color: #050302;
            background-image: radial-gradient(circle at 50% 50%, #2b1d0e 0%, #000000 100%);
            color: var(--parchment);
            font-family: 'Lato', sans-serif;
            margin: 0;
            height: 100vh;
            overflow: hidden;
            user-select: none;
        }

        button {
            background: linear-gradient(to bottom, #d4af37 0%, #a88520 100%);
            border: 2px solid #5e4020;
            border-radius: 4px;
            color: #1a0f05;
            font-family: 'Cinzel', serif;
            font-weight: bold;
            padding: 8px 16px;
            cursor: pointer;
            transition: all 0.2s;
        }

        button:hover {
            transform: scale(1.05);
            filter: brightness(1.1);
        }

        button:disabled {
            background: #333;
            color: #777;
            border-color: #444;
            cursor: not-allowed;
            filter: grayscale(100%);
        }

        button.btn-red {
            background: linear-gradient(to bottom, #8a1c1c 0%, #520e0e 100%);
            color: white;
            border-color: #2b0505;
        }

        input {
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid var(--gold);
            color: var(--gold);
            padding: 10px;
            font-family: 'Cinzel';
            text-align: center;
            margin: 10px;
            border-radius: 4px;
            font-size: 1.1rem;
            width: 200px;
        }

        /* SCREENS */
        .full-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #landing-screen {
            z-index: 150;
        }

        #landing-screen h1 {
            font-size: 4rem;
            margin-bottom: 40px;
            text-shadow: 0 0 20px var(--gold);
            color: var(--gold);
            font-family: 'Cinzel';
        }

        /* LOBBY FIXES */
        .lobby-table {
            width: 300px;
            height: 300px;
            border-radius: 50%;
            background: radial-gradient(circle, #5e4020 0%, #2b1d0e 100%);
            border: 8px solid var(--gold);
            position: relative;
            margin: 40px;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.8);
        }

        .lobby-seat {
            width: 60px;
            height: 60px;
            background: #222;
            border-radius: 50%;
            position: absolute;
            cursor: pointer;
            border: 2px solid #555;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #fff;
            transform: translate(-50%, -50%);
            transition: all 0.3s;
        }

        .lobby-seat:hover:not(.taken) {
            transform: translate(-50%, -50%) scale(1.2);
            background: var(--gold);
            color: #000;
        }

        .lobby-seat.taken {
            background: var(--red);
            border-color: #500;
            cursor: default;
        }

        /* Player List Sidebar - Moved to Left */
        #lobby-info {
            position: absolute;
            left: 40px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(20, 10, 5, 0.8);
            border: 1px solid var(--gold);
            padding: 20px;
            border-radius: 8px;
            min-width: 220px;
            text-align: left;
        }

        #lobby-info h3 {
            margin-top: 0;
            border-bottom: 1px solid var(--gold);
            padding-bottom: 5px;
            color: var(--gold);
            font-family: 'Cinzel';
        }

        .lobby-player-row {
            padding: 8px 0;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
        }

        /* GAME BOARD */
        #game-board {
            display: none;
            width: 100%;
            height: 100vh;
            position: relative;
        }

        #center-table {
            width: 45vw;
            height: 45vw;
            max-width: 600px;
            max-height: 600px;
            background-color: var(--wood-light);
            background-image: url("https://www.transparenttextures.com/patterns/wood-pattern.png");
            border-radius: 50%;
            border: 12px solid #261608;
            position: absolute;
            top: 45%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: inset 0 0 80px #000, 0 20px 50px rgba(0, 0, 0, 0.8);
            z-index: 1;
        }

        #center-table::after {
            content: '';
            position: absolute;
            top: 10%;
            left: 10%;
            width: 80%;
            height: 80%;
            background: var(--green-felt);
            border-radius: 50%;
            box-shadow: inset 0 0 40px rgba(0, 0, 0, 0.6);
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        /* CARDS */
        .card-lg {
            width: 90px;
            height: 135px;
            background-color: #1a0f05;
            background-size: cover;
            border-radius: 6px;
            border: 2px solid #444;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.6);
            transition: transform 0.2s;
            position: relative;
            display: inline-block;
            margin: 0 5px;
        }

        .card-lg:hover {
            transform: translateY(-15px) scale(1.05);
            border-color: var(--gold);
            z-index: 10;
        }

        .card-name-overlay {
            position: absolute;
            bottom: 5px;
            left: 0;
            width: 100%;
            text-align: center;
            color: rgba(255, 244, 188, 0.9);
            font-family: 'Cinzel', serif;
            font-size: 0.75rem;
            pointer-events: none;
            text-shadow: 2px 2px 3px black;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.9), transparent);
            padding-bottom: 4px;
        }

        .card-Governor {
            background-image: url('/static/governor.png');
        }

        .card-Mercenary {
            background-image: url('/static/mercenary.png');
        }

        .card-Diplomat {
            background-image: url('/static/diplomat.png');
        }

        .card-Commander {
            background-image: url('/static/commander.png');
        }

        .card-Matriarch {
            background-image: url('/static/matriarch.png');
        }

        .card-back {
            background: repeating-linear-gradient(45deg, #3e2b19, #3e2b19 10px, #2b1d0e 10px, #2b1d0e 20px);
            border: 1px solid #5e4020;
        }

        .dead {
            filter: grayscale(100%) brightness(40%);
            border-color: var(--red) !important;
        }

        /* UI CONTROLS */
        .top-btn-container {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 200;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .icon-btn {
            background: var(--wood-light);
            border: 2px solid var(--gold);
            color: var(--gold);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-family: 'Cinzel';
            font-weight: bold;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        #controls-area {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(to top, #1a0f05 90%, transparent 100%);
            padding: 10px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 50;
            border-top: 1px solid #333;
        }

        /* HAND AREA FIX: Center cards */
        #my-hand-area {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 10px;
            width: 100%;
        }

        #status-msg {
            font-family: 'Cinzel';
            color: var(--gold);
            font-size: 1.2rem;
            margin-bottom: 5px;
            min-height: 24px;
        }

        .action-bar {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            justify-content: center;
            max-width: 800px;
        }

        /* LOG */
        #game-log-container {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 250px;
            height: 300px;
            background: rgba(20, 10, 5, 0.85);
            border: 2px solid var(--gold);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            z-index: 20;
        }

        #game-log {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            font-size: 0.85rem;
            color: #ddd;
        }

        .log-msg {
            margin-bottom: 5px;
            border-bottom: 1px solid #333;
        }

        .log-name {
            color: var(--gold);
            font-weight: bold;
        }

        /* SEATS */
        #seats-container {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
        }

        .seat-pos {
            position: absolute;
            width: 140px;
            text-align: center;
            pointer-events: auto;
            transition: all 0.5s;
        }

        .seat-info {
            background: rgba(20, 10, 5, 0.9);
            border: 2px solid #555;
            padding: 8px;
            border-radius: 8px;
            box-shadow: 0 4px 10px #000;
            transition: all 0.3s;
        }

        .active-turn .seat-info {
            border-color: var(--gold);
            box-shadow: 0 0 20px var(--gold);
            transform: scale(1.05);
        }

        .target-pulse {
            animation: targetPulse 1s infinite;
        }

        @keyframes targetPulse {
            0% {
                box-shadow: 0 0 0 0 rgba(138, 28, 28, 0.7);
            }

            100% {
                box-shadow: 0 0 0 15px rgba(138, 28, 28, 0);
            }
        }

        .card-sm {
            width: 35px;
            height: 52px;
            background: #111;
            border-radius: 3px;
            display: inline-block;
            margin: 1px;
            background-size: cover;
            border: 1px solid #333;
        }

        /* MODALS */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 200;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .modal-cards {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .overlay-ui {
            display: none;
        }

        .cs-row {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid #444;
            padding: 4px 0;
            align-items: center;
        }

        .cs-role {
            color: var(--gold);
            font-weight: bold;
            font-family: 'Cinzel';
            font-size: 1.1rem;
        }

        .rules-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 600px;
            height: 60vh;
            background: #1a0f05;
            border: 2px solid var(--gold);
            z-index: 300;
            flex-direction: column;
            border-radius: 8px;
        }

        .rules-header {
            background: var(--wood-light);
            padding: 10px;
            display: flex;
            justify-content: space-between;
            border-bottom: 2px solid var(--gold);
        }

        .rules-body {
            padding: 20px;
            overflow-y: auto;
            color: #ddd;
            line-height: 1.6;
        }

        .tab-btn {
            background: none;
            border: none;
            color: #888;
            padding: 10px;
            cursor: pointer;
            font-family: 'Cinzel';
            flex: 1;
            border-bottom: 2px solid transparent;
        }

        .tab-btn.active {
            color: var(--gold);
            border-color: var(--gold);
        }

        .rules-section {
            display: none;
        }

        .rules-section.active {
            display: block;
        }
    </style>
</head>

<body>
    <audio id="sfx-coins" src="/static/coins.mp3"></audio>
    <audio id="sfx-drama" src="/static/drama.mp3"></audio>
    <audio id="sfx-stab" src="/static/stab.mp3"></audio>
    <audio id="sfx-heartbeat" src="/static/heartbeat.mp3" loop></audio>

    <div class="top-btn-container">
        <button class="icon-btn" onclick="toggleCheatsheet()">?</button>
        <button class="icon-btn" onclick="toggleRules()">I</button>
        <button class="icon-btn" onclick="toggleFeedback()">âœ‰</button>
        <a href="https://ko-fi.com/bane007" target="_blank" style="text-decoration: none;">
            <button class="icon-btn"
                style="width: auto; padding: 0 15px; font-size: 0.8rem; background: var(--red); color: var(--parchment); border-color: #520e0e;">
                â™¥ Support
            </button>
        </a>
    </div>

    <!-- CHEATSHEET -->
    <div id="cheatsheet-popup"
        style="display: none; position: absolute; top: 70px; left: 20px; background: rgba(20, 10, 5, 0.95); border: 2px solid var(--gold); padding: 15px; border-radius: 8px; color: #ddd; width: 300px; z-index: 210;">
        <h3 style="margin-top:0; color:var(--gold); text-align:center; font-family:'Cinzel'">Roles & Abilities</h3>
        <div class="cs-row"><span class="cs-role">Governor</span>
            <div style="text-align:right; font-size:0.9rem;">
                <div style="color:#fff">Embezzle (+3)</div>
                <div style="color:#888; font-style:italic;">Blocks Foreign Funds</div>
            </div>
        </div>
        <div class="cs-row"><span class="cs-role">Mercenary</span>
            <div style="text-align:right; font-size:0.9rem;">
                <div style="color:#fff">Eliminate (Kill)</div>
                <div style="color:#444;">-</div>
            </div>
        </div>
        <div class="cs-row"><span class="cs-role">Commander</span>
            <div style="text-align:right; font-size:0.9rem;">
                <div style="color:#fff">Extort (+2)</div>
                <div style="color:#888; font-style:italic;">Blocks Extort</div>
            </div>
        </div>
        <div class="cs-row"><span class="cs-role">Diplomat</span>
            <div style="text-align:right; font-size:0.9rem;">
                <div style="color:#fff">Reshuffle</div>
                <div style="color:#888; font-style:italic;">Blocks Extort</div>
            </div>
        </div>
        <div class="cs-row"><span class="cs-role">Matriarch</span>
            <div style="text-align:right; font-size:0.9rem;">
                <div style="color:#444;">-</div>
                <div style="color:#888; font-style:italic;">Blocks Eliminate</div>
            </div>
        </div>
    </div>

    <!-- GAME GUIDE -->
    <div id="game-guide-modal" class="rules-modal">
        <div class="rules-header">
            <h2 style="margin:0; color:var(--gold); font-family:'Cinzel'">How to Play</h2>
            <button onclick="toggleRules()"
                style="background:none; border:none; color:var(--red); font-size:1.5rem; cursor:pointer;">Ã—</button>
        </div>
        <div style="display:flex; background:#111;">
            <button class="tab-btn active" onclick="openTab('overview')">Goal & Flow</button>
            <button class="tab-btn" onclick="openTab('bluffing')">Bluffing</button>
            <button class="tab-btn" onclick="openTab('challenges')">Challenges</button>
        </div>
        <div class="rules-body">
            <div id="tab-overview" class="rules-section active">
                <h3>Objective</h3>
                <p>Be the last player with <strong>Loyalty</strong>. You start with 2 face-down cards. If you lose both,
                    you are exiled.</p>
                <h3>Turn Structure</h3>
                <p>On your turn, choose <strong>ONE action</strong>. You cannot pass.</p>
                <h3>General Actions</h3>
                <p><strong>Income:</strong> Take 1 Coin. (Safe).</p>
                <p><strong>Foreign Funds:</strong> Take 2 Coins. (Can be blocked).</p>
                <p><strong>Execute:</strong> Pay 7 Coins. Kill a player's Loyalty instantly. (Unblockable).</p>
            </div>
            <div id="tab-bluffing" class="rules-section">
                <h3>The Art of Treason</h3>
                <p>You can claim to have any card you want. Example: Claim <strong>Governor</strong> to take 3 coins,
                    even if you don't have it.</p>
            </div>
            <div id="tab-challenges" class="rules-section">
                <h3>Challenging</h3>
                <p>Any player can Challenge a character action. If you are challenged and <strong>HAVE</strong> the
                    card, you show it and reshuffle. The challenger loses a Loyalty. If you <strong>DON'T</strong> have
                    it, you lose a Loyalty.</p>
            </div>
        </div>
    </div>

    <!-- FEEDBACK MODAL -->
    <div id="feedback-modal" class="modal-overlay">
        <div
            style="background: #1a0f05; padding: 30px; border: 2px solid var(--gold); border-radius: 10px; width: 90%; max-width: 400px; text-align: center;">
            <h2 style="color: var(--gold); font-family: 'Cinzel'; margin-top: 0;">Feedback & Bugs</h2>
            <div id="feedback-form">
                <textarea id="feedback-text" placeholder="Describe your idea or bug..."
                    style="width: 100%; height: 100px; background: #222; color: #ddd; border: 1px solid #555; padding: 10px; margin-bottom: 10px; border-radius: 4px; font-family: 'Lato'; resize: none;"></textarea>
                <div style="display: flex; justify-content: center; gap: 10px;">
                    <button onclick="toggleFeedback()" style="background: #444; border-color: #666;">Cancel</button>
                    <button onclick="sendFeedback()">Send</button>
                </div>
            </div>
            <div id="feedback-success" style="display: none; flex-direction: column; align-items: center; gap: 15px;">
                <div style="color: var(--parchment); font-size: 1.1rem;">Your message has been sent to the
                    developer.<br>Thank you for improving the game!</div>
                <div style="font-size: 2rem;">ðŸ“œ âœ¨</div>
                <button onclick="toggleFeedback()">Close</button>
            </div>
        </div>
    </div>

    <!-- LANDING / LOBBY -->
    <div id="landing-screen" class="full-screen">
        <h1>TREASON</h1>
        <button onclick="createRoom()" style="font-size: 1.5rem; margin: 20px; width: 280px;">CREATE ROOM</button>
        <div class="landing-row">
            <input id="room-code-input" placeholder="ROOM CODE" maxlength="4" style="text-transform: uppercase;">
            <button onclick="joinRoom()" style="height: 44px;">JOIN</button>
        </div>
        <div id="landing-error" style="color: var(--red); margin-top: 10px; font-family: 'Cinzel';"></div>
    </div>

    <div id="lobby-screen" class="full-screen" style="display:none;">
        <h2 style="color: var(--gold); font-family: 'Cinzel'; font-size: 2.5rem;">ROOM: <span
                id="display-room-code">????</span></h2>
        <div id="lobby-info">
            <h3>Players</h3>
            <div id="lobby-list-content"></div>
        </div>
        <input id="username" placeholder="Enter Name" style="padding: 10px; text-align: center;">
        <div class="lobby-table" id="lobby-slots"></div>
        <button id="btn-start" onclick="requestStart()" style="margin-top: 30px; display:none;">START GAME</button>
    </div>

    <!-- GAME BOARD -->
    <div id="game-board">
        <!-- SVG LAYER FOR TARGETING ARROW -->
        <svg id="action-canvas" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10;">
            <defs>
                <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
                    <polygon points="0 0, 10 3.5, 0 7" fill="#8a1c1c" />
                </marker>
            </defs>
        </svg>

        <div id="game-log-container">
            <div
                style="padding:5px; border-bottom:1px solid var(--gold); text-align:center; color:var(--gold); font-family:'Cinzel'">
                Chronicles</div>
            <div id="game-log"></div>
        </div>
        <div id="center-table"></div>
        <div id="seats-container"></div>
        <div id="controls-area">
            <div id="status-msg"></div>
            <div style="color:var(--gold); font-family:'Cinzel'; border:2px solid #5e4020; padding:2px 15px; border-radius:15px; background:rgba(0,0,0,0.6); margin-bottom:5px;"
                id="my-coins-display">Coins: 0</div>
            <div id="main-actions" class="action-bar" style="display:none;">
                <button onclick="doAction('income', this)">Income</button>
                <button onclick="doAction('foreign_funds', this)">Foreign Funds</button>
                <button id="btn-coup" onclick="startTargeting('execute', this)" class="btn-red">Execute (7)</button>
                <button onclick="doAction('embezzle', this)">Embezzle</button>
                <button id="btn-kill" onclick="startTargeting('eliminate', this)" class="btn-red">Eliminate (3)</button>
                <button onclick="startTargeting('extort', this)">Extort</button>
                <button onclick="doAction('reshuffle', this)">Reshuffle</button>
            </div>
            <div id="reaction-ui" class="overlay-ui action-bar">
                <button onclick="respond('allow')">Allow</button>
                <button id="blk-gov" onclick="respond('block', 'Governor')">Intercept (Gov)</button>
                <button id="blk-cmdr" onclick="respond('block', 'Commander')">Intercept (Cmdr)</button>
                <button id="blk-diplo" onclick="respond('block', 'Diplomat')">Intercept (Diplo)</button>
                <button id="blk-matri" onclick="respond('block', 'Matriarch')">Intercept (Matri)</button>
                <button id="btn-chal" onclick="respond('challenge')" class="btn-red">Challenge</button>
            </div>
            <div id="exchange-ui" class="overlay-ui" style="text-align:center; margin-bottom:10px;">
                <div id="ex-instruction" style="color:var(--gold); font-family:'Cinzel'; margin-bottom:5px;">Select
                    cards to KEEP</div>
                <div style="display:flex; gap:20px; justify-content:center;">
                    <div><small style="color:#aaa">HAND</small>
                        <div id="ex-hand-zone" style="display:flex; gap:5px;"></div>
                    </div>
                    <div><small style="color:#aaa">DECK</small>
                        <div id="ex-deck-zone" style="display:flex; gap:5px;"></div>
                    </div>
                </div>
                <button onclick="confirmExchange()" style="margin-top:10px;">Confirm Selection</button>
            </div>
            <div id="my-hand-area"></div>
        </div>
    </div>

    <div id="discard-modal" class="modal-overlay">
        <div style="font-family:'Cinzel'; font-size:2rem; color:var(--red); margin-bottom:10px;">Exposed!</div>
        <div style="color:#ccc; margin-bottom:20px;">Select a Loyalty to discard</div>
        <div class="modal-cards" id="discard-container"></div>
    </div>

    <div id="victory-modal" class="modal-overlay">
        <div style="font-family:'Cinzel'; font-size:3rem; color:var(--gold);">VICTORY</div>
        <div id="winner-name" style="font-size:1.5rem; color:#fff; margin:20px;"></div>
        <!-- FIXED: Closes modal to reveal lobby instead of reloading -->
        <button onclick="document.getElementById('victory-modal').style.display='none'">Return to Lobby</button>
    </div>

    <script>
        const socket = io();
        let mySeat = -1;
        let targetingMode = null;
        let lastTableData = {};
        let exSelected = []; let exPool = []; let exKeepCount = 0;

        window.onload = () => { document.querySelectorAll('audio').forEach(a => a.volume = 0.5); };

        function toggleCheatsheet() {
            const el = document.getElementById('cheatsheet-popup');
            const other = document.getElementById('game-guide-modal');
            other.style.display = 'none';
            el.style.display = (el.style.display === 'block') ? 'none' : 'block';
        }
        function toggleRules() {
            const el = document.getElementById('game-guide-modal');
            const other = document.getElementById('cheatsheet-popup');
            other.style.display = 'none';
            el.style.display = (el.style.display === 'flex') ? 'none' : 'flex';
        }
        function toggleFeedback() {
            const el = document.getElementById('feedback-modal');
            if (el.style.display === 'flex') {
                el.style.display = 'none';
                setTimeout(() => {
                    document.getElementById('feedback-form').style.display = 'block';
                    document.getElementById('feedback-success').style.display = 'none';
                }, 200);
            } else {
                el.style.display = 'flex';
                document.getElementById('feedback-text').focus();
            }
        }
        function openTab(n) {
            document.querySelectorAll('.rules-section').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active'));
            document.getElementById('tab-' + n).classList.add('active');
            event.target.classList.add('active');
        }

        function sendFeedback() {
            const t = document.getElementById('feedback-text').value;
            const n = document.getElementById('username').value || "Anonymous";
            if (!t) return;
            const btn = document.querySelector('#feedback-form button:last-child');
            const og = btn.innerText; btn.disabled = true; btn.innerText = "Sending...";
            fetch('/submit_feedback', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: t, name: n })
            }).then(r => {
                if (r.ok) {
                    document.getElementById('feedback-form').style.display = 'none';
                    document.getElementById('feedback-success').style.display = 'flex';
                    document.getElementById('feedback-text').value = "";
                } else alert("Error");
            }).finally(() => { btn.disabled = false; btn.innerText = og; });
        }

        function createRoom() { socket.emit('create_room', {}); }
        function joinRoom() {
            const c = document.getElementById('room-code-input').value;
            if (c.length === 4) socket.emit('join_room', { code: c });
            else document.getElementById('landing-error').innerText = "Invalid Code";
        }
        socket.on('room_joined', d => {
            document.getElementById('landing-screen').style.display = 'none';
            document.getElementById('lobby-screen').style.display = 'flex';
            document.getElementById('display-room-code').innerText = d.code;
        });
        socket.on('error', d => alert(d.msg));

        const posCoords = [{ top: '10px', left: '50%' }, { top: '25%', left: '85%' }, { top: '75%', left: '85%' }, { top: '90%', left: '50%' }, { top: '75%', left: '15%' }, { top: '25%', left: '15%' }];
        
        socket.on('lobby_update', data => {
            const slots = document.getElementById('lobby-slots'); slots.innerHTML = '';
            const list = document.getElementById('lobby-list-content'); list.innerHTML = '';
            let seated = false;
            for (let i = 0; i < 6; i++) {
                const s = document.createElement('div');
                s.style.top = posCoords[i].top; s.style.left = posCoords[i].left;
                s.className = data.seats[i] ? 'lobby-seat taken' : 'lobby-seat';
                s.innerText = data.seats[i] ? data.seats[i].substring(0, 4) : (i + 1);
                if (!data.seats[i]) s.onclick = () => sit(i);
                slots.appendChild(s);
                if (data.seats[i]) {
                    const d = document.createElement('div');
                    d.className = "lobby-player-row";
                    d.innerHTML = `<span>${data.seats[i]}</span>` + ((i === parseInt(data.host_seat)) ? ' <span style="color:var(--gold); font-size:0.8rem">HOST</span>' : '');
                    list.appendChild(d);
                    if (i === mySeat) seated = true;
                }
            }
            const btn = document.getElementById('btn-start');
            if (seated && mySeat === parseInt(data.host_seat)) {
                btn.style.display = 'block';
                const count = Object.values(data.seats).filter(x => x).length;
                btn.disabled = count < 2;
                btn.innerText = count < 2 ? "Need 2 Players" : "START GAME";
            } else btn.style.display = 'none';
            
            // FIX: Handle switching back to lobby if game ends
            if (data.started) { 
                document.getElementById('lobby-screen').style.display = 'none'; 
                document.getElementById('game-board').style.display = 'block'; 
            } else {
                document.getElementById('lobby-screen').style.display = 'flex'; 
                document.getElementById('game-board').style.display = 'none'; 
            }
        });

        function sit(idx) {
            const n = document.getElementById('username').value;
            if (!n) { alert("Enter Name!"); return; }
            mySeat = idx;
            socket.emit('sit_down', { seat: idx, name: n });
        }
        function requestStart() { socket.emit('start_game_request'); }

        function renderGame(state, seatsOnly = false) {
            if (!seatsOnly) {
                mySeat = state.my_seat;
                lastTableData = state.table;
            }
            const seatCont = document.getElementById('seats-container');
            seatCont.innerHTML = '';
            const tableData = seatsOnly ? lastTableData : state.table;

            for (let sid in tableData) {
                sid = parseInt(sid);
                if (sid === mySeat) continue;
                const p = tableData[sid];
                const idx = (sid - mySeat + 3 + 6) % 6;
                const angle = (idx * 60 - 90) * (Math.PI / 180);
                const x = 50 + 35 * Math.cos(angle); const y = 45 + 35 * Math.sin(angle);

                const el = document.createElement('div');
                el.className = `seat-pos ${(!seatsOnly && state.turn_seat === sid) ? 'active-turn' : ''}`;
                el.style.left = x + '%'; el.style.top = y + '%'; el.style.transform = 'translate(-50%,-50%)';
                el.innerHTML = `
                    <div class="seat-info ${p.alive ? '' : 'dead'}">
                        <div style="font-weight:bold; color:var(--gold)">${p.name}</div>
                        <div style="font-size:0.8rem">Coins: ${p.coins}</div>
                    </div>
                    <div style="margin-top:5px;">
                        ${p.hand.map(c => `<div class="card-sm ${c.alive ? 'card-back' : ('card-' + c.role + ' dead')}"></div>`).join('')}
                    </div>
                `;
                if (targetingMode && p.alive) {
                    el.style.cursor = 'pointer';
                    const infoBox = el.querySelector('.seat-info');
                    infoBox.style.borderColor = 'var(--red)';
                    infoBox.style.boxShadow = '0 0 15px var(--red)';
                    infoBox.classList.add('target-pulse');
                    el.onclick = function () {
                        socket.emit('action', { type: targetingMode, target_seat: sid });
                        targetingMode = null;
                        document.getElementById('status-msg').innerText = "WAITING...";
                        renderGame({}, true);
                    };
                }
                seatCont.appendChild(el);
            }
        }

        // NEW FUNCTION: Draw Arrow
        function drawArrow(data) {
            const cvs = document.getElementById('action-canvas');
            while (cvs.lastChild && cvs.lastChild.tagName !== 'defs') {
                cvs.removeChild(cvs.lastChild);
            }
            if (!data || data.from == null || data.to == null) return;

            const getPos = (sid) => {
                const idx = (sid - mySeat + 3 + 6) % 6; 
                const angle = (idx * 60 - 90) * (Math.PI / 180);
                return { x: 50 + 35 * Math.cos(angle), y: 45 + 35 * Math.sin(angle) };
            };

            const start = getPos(data.from);
            const end = getPos(data.to);

            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('x1', start.x + '%'); line.setAttribute('y1', start.y + '%');
            line.setAttribute('x2', end.x + '%'); line.setAttribute('y2', end.y + '%');
            line.setAttribute('stroke', '#8a1c1c'); line.setAttribute('stroke-width', '4');
            line.setAttribute('marker-end', 'url(#arrowhead)');
            cvs.appendChild(line);

            if (data.label) {
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', (start.x + end.x) / 2 + '%');
                text.setAttribute('y', (start.y + end.y) / 2 + '%');
                text.setAttribute('fill', '#d4af37'); text.setAttribute('font-family', 'Cinzel');
                text.setAttribute('font-size', '24'); text.setAttribute('font-weight', 'bold');
                text.setAttribute('text-anchor', 'middle'); text.setAttribute('dy', '-10');
                text.textContent = data.label;
                cvs.appendChild(text);
            }
        }

        socket.on('game_update', state => {
            renderGame(state, false);
            
            // CALL DRAW ARROW
            drawArrow(state.arrow);

            if (state.table[mySeat]) {
                document.getElementById('my-coins-display').innerText = "Coins: " + state.table[mySeat].coins;
                const coins = state.table[mySeat].coins;
                document.getElementById('btn-coup').disabled = coins < 7;
                document.getElementById('btn-kill').disabled = coins < 3;
            }
            if (state.log) { const l = document.getElementById('game-log'); l.innerHTML += `<div class="log-msg">${state.log}</div>`; l.scrollTop = l.scrollHeight; }
            if (state.sfx) { document.getElementById('sfx-' + state.sfx).play().catch(() => { }); }

            const h = document.getElementById('my-hand-area'); h.innerHTML = '';
            state.my_hand.forEach((c, i) => {
                const d = document.createElement('div'); d.className = `card-lg card-${c.role} ${c.alive ? '' : 'dead'}`;
                d.innerHTML = `<div class="card-name-overlay">${c.role}</div>`;
                h.appendChild(d);
            });

            const acts = document.getElementById('main-actions');
            const react = document.getElementById('reaction-ui');
            const exch = document.getElementById('exchange-ui');
            const disc = document.getElementById('discard-modal');
            acts.style.display = 'none'; react.style.display = 'none'; exch.style.display = 'none'; disc.style.display = 'none';

            if (state.discard_needed) {
                document.getElementById('status-msg').innerText = "LOSE LOYALTY";
                disc.style.display = 'flex';
                const c = document.getElementById('discard-container'); c.innerHTML = '';
                state.my_hand.forEach((card, i) => {
                    if (card.alive) {
                        const el = document.createElement('div'); el.className = `card-lg card-${card.role}`; el.style.cursor = 'pointer';
                        el.onclick = () => socket.emit('discard', { index: i });
                        c.appendChild(el);
                    }
                });
            }
            else if (state.exchange_needed) {
                document.getElementById('status-msg').innerText = "RESHUFFLE";
                exch.style.display = 'block';
                exPool = state.exchange_data.pool; exKeepCount = state.exchange_data.keep_count; exSelected = [];
                renderExchange();
            }
            else if (state.interaction_needed) {
                document.getElementById('status-msg').innerText = "RESPONSE NEEDED";
                react.style.display = 'flex';
                document.querySelectorAll('#reaction-ui button').forEach(b => b.style.display = 'none');
                document.querySelector('#reaction-ui button:first-child').style.display = 'inline-block';
                const t = state.interaction_type; const n = state.pending_act_name;
                if (t === 'challenge_action' && n !== 'foreign_funds') document.getElementById('btn-chal').style.display = 'inline-block';
                if (t === 'challenge_block') document.getElementById('btn-chal').style.display = 'inline-block';
                if (t === 'block_action') {
                    if (n === 'foreign_funds') document.getElementById('blk-gov').style.display = 'inline-block';
                    if (n === 'extort') { document.getElementById('blk-cmdr').style.display = 'inline-block'; document.getElementById('blk-diplo').style.display = 'inline-block'; }
                    if (n === 'eliminate') document.getElementById('blk-matri').style.display = 'inline-block';
                }
            }
            else if (state.turn_seat === mySeat) {
                if (state.table[mySeat] && !state.table[mySeat].alive) {
                    document.getElementById('status-msg').innerText = "ELIMINATED";
                } else {
                    if (targetingMode) document.getElementById('status-msg').innerText = "SELECT TARGET";
                    else if (state.pending_act_name) document.getElementById('status-msg').innerText = "WAITING...";
                    else {
                        acts.style.display = 'flex';
                        document.getElementById('status-msg').innerText = "YOUR TURN";
                        document.querySelectorAll('#main-actions button').forEach(b => {
                            if (b.id === 'btn-coup') b.disabled = state.table[mySeat].coins < 7;
                            else if (b.id === 'btn-kill') b.disabled = state.table[mySeat].coins < 3;
                            else b.disabled = false;
                            b.classList.remove('active-action');
                        });
                    }
                }
            } else {
                const turnName = state.table[state.turn_seat] ? state.table[state.turn_seat].name : "Opponent";
                document.getElementById('status-msg').innerText = `Waiting for ${turnName}...`;
            }
        });

        function renderExchange() {
            const h = document.getElementById('ex-hand-zone'); h.innerHTML = '';
            const d = document.getElementById('ex-deck-zone'); d.innerHTML = '';
            exPool.forEach((r, i) => {
                const el = document.createElement('div'); el.className = `card-lg card-${r}`; el.style.cursor = 'pointer';
                el.style.width = '70px'; el.style.height = '105px';
                el.onclick = () => {
                    if (exSelected.includes(i)) { exSelected = exSelected.filter(x => x !== i); el.style.border = '2px solid #444'; }
                    else if (exSelected.length < exKeepCount) { exSelected.push(i); el.style.border = '3px solid var(--gold)'; }
                };
                if (i < exKeepCount) h.appendChild(el); else d.appendChild(el);
            });
        }
        function confirmExchange() { if (exSelected.length === exKeepCount) socket.emit('finish_exchange', { kept_roles: exSelected.map(i => exPool[i]) }); }

        function doAction(t, btn) {
            btn.classList.add('active-action');
            document.querySelectorAll('#main-actions button').forEach(b => { if (b !== btn) b.disabled = true; });
            socket.emit('action', { type: t });
        }
        function startTargeting(t, btn) {
            btn.classList.add('active-action');
            document.querySelectorAll('#main-actions button').forEach(b => { if (b !== btn) b.disabled = true; });
            targetingMode = t;
            document.getElementById('status-msg').innerText = "SELECT TARGET";
            renderGame({}, true);
        }
        function respond(c, r) { socket.emit('response', { choice: c, role: r }); }
        socket.on('game_over', d => { document.getElementById('victory-modal').style.display = 'flex'; document.getElementById('winner-name').innerText = d.winner + " Wins!"; });
    </script>
</body>

</html>
